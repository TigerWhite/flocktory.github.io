---
layout: doc
title:  "Xmail"
section: integration
---

# Интеграция модуля XMail (Client Based Mail Server)

## Описание продукта

Система XMail от Flocktory позволяет дополнительно монетизировать клиентскую базу вашего сайта с помощью таргетирования пользователей персонализированными рекламными кампаниями при участии ряда эксклюзивных enterprise-партнеров Flocktory.

В среде e-commerce многие называют этот подход «email retargeting». Его суть состоит в том, что пользователи вашего портала могут получить персонализированную рекламу при посещении партнерского сайта и срабатывании событийного триггера, например, при брошенной корзине. Система Flocktory отслеживает подобные триггеры на площадках партнеров, при этом проверяя разрешенные вами правила управления системой, которые вы предварительно настраиваете через личный кабинет Flocktory. При срабатывании разрешенного сценария мы отправляем email через ваш канал коммуникации непосредственно пользователю. Далее, когда этот пользователь совершает покупку с использованием уникальной ссылки, встроенной в таргетированное сообщение, ваш сайт зарабатывает комиссию за продажу, в то же время предлагая пользователю полезную услугу, тем самым повышая лояльность к вашему бренду и увеличивая показатели данного канала.

## Предпосылки

Указанная ниже техническая инструкция подразумевает, что следующие сценарии актуальны для вашего сайта:

* Вы хотите использовать собственный SMTP-шлюз (почтовый сервер) для доставки email вашим клиентам. (Имейте ввиду, что система Flocktory может быть использована как обработчик этих сообщений. Для этого попросите вашего аккаунт-менеджера о дополнительных инструкциях);
* Почтовый сервер вашего сайта работает на Apache или Nginx (мы можем самостоятельно проверить это за вас);
* Почтовый сервер вашего сайта поддерживает php-скрипты (мы можем самостоятельно проверить это за вас).

## Технические ресурсы, необходимые для настройки интеграции
Каждая отдельная кампания имеет собственные отличия, однако, исходя из нашего опыта, для успешного окончания несложного процесса интеграции вам понадобятся следующие ресурсы от вашей команды:

* Системный администратор (необходим для настройки вашего веб-сервера и серверных скриптов);
* Front-end разработчик (пожалуйста, обратите внимание: если ваша компания использует Google Tag Manager или схожие инструменты, то вы можете напрямую работать через данные инструменты).

## Обзор интеграционного процесса
Техническая интеграция модуля XMail состоит из двух простых шагов, которые указаны ниже. Они также позволяют проверить корректность интеграции системы в ваш портал:

* Настройка сопоставления пользовательской сессии на вашем сайте с Flocktory (cookie matching);
* Настройка серверных скриптов для обработки запросов от модуля Flocktory и дальнейшей отправки email через SMTP.

## Настройка сопоставления пользовательской сессии с системой XMail
Цель данного шага состоит в синхронизации данных о пользовательских сессиях с системой Flocktory при нахождении зарегистрированного пользователя на вашем сайте. Для данного типа пользователей, у вас всегда должен быть валидный email адрес в личном профайле.

Для завершения этого шага нужно добавить следующий html-код на все страницы вашего сайта, если по текущей пользовательской сессии вы идентифицировали зарегистрированного пользователя (email адрес известен):

```html
<img src="http://flocktory.com/xmail/v1/track?partner=YOUR_SITE_ID&token=1" />
```

## Параметры
Параметр | Значение
---------|---------
token    | Идентификатор пользователя. Обычно это авто-инкрементное, уникальное число в таблице пользователя. ( Например, в таблице customers# колонка id# )
partner  | Ваш идентификатор площадки в системе Flocktory.  Ваш ID: 1781


Пожалуйста, не забудьте заменить параметры, которые вы передаете во Flocktory, на правильные. Очень важно передавать валидные значения для token и partner на всех страницах и на всех сессиях, где виден зарегистрированный пользователь.

Если вы используете Google Tag Manager (или схожие продукты), вы можете завершить этот шаг путем исполнения данного кода на всех страницах и для корректной передачи элемента Data Layer для token (дополнительную инструкцию по работе в Google Tag Manager можно получить у аккаунт-менеджера Floсktory).

Для валидации данной части интеграции, после того как вышеуказанная метка была добавлена на все страницы, вы можете сделать следующее:

1. Авторизоваться на вашем веб-портале как пользователь User1 с существующим email-адресом в вашей базе данных;
  * Перейти на любую страницу и открыть код страницы (page console) в вашем браузере;
  * Найти метку Flockrory (указана выше) и подтвердить, что token (User1) тот же самый, который только что авторизовался на портале, и что partner соответствует параметрам, указанным в настоящей инструкции;
  * Выйти из системы под User1;
2. После выхода из аккаунта User1 перейти на любую страницу на вашем портале и проверить код страницы для подтверждения того, что метка Flocktory ОТСУТСТВУЕТ (поскольку вы НЕЗАРЕГИСТРИРОВАННЫЙ пользователь);
3. Авторизоваться на портале как User2 с существующим email-адресом в вашей базе данных;
  * Перейти на любую страницу и открыть код страницы (page console) в вашем браузере;
  * Найти метку Flocktory (указана выше) и подтвердить, что token (User2) тот же самый, что и тот, который только что авторизовался на портале и что site_id соответствует параметрам, указанным в настоящей инструкции;
  * Убедиться, что token уникален для User2;

Успешное выполнение данного тестирования подтверждает, что вы провели успешно провели интеграцию шага 1 и можете переходить к настройке шага 2, которая требует внедрения серверных скриптов и непосредственно конфигурирует веб-сервер вашего сайта.

## Настройка серверных скриптов для обработки запросов от Flocktory и отправки имейлов через ваш SMTP.

В рамках Шага 2, мы сначала отработаем два скрипта, для корректной настройки соединения SMTP и сервера БД. (Скрипты должны быть предоставлены аккаунт-менджером Flocktory)

Вы должны были получить два файла от Flocktory:

* config.php — скрипт, который необходимо отрегулировать для настройки вашего соединения;
* worker.php — скрипт, который необходимо разместить в том же самом месте, где и config.php, который будет обрабатывать запросы от Flocktory;

Инструкция подразумевает, что ваш сайт работает на Apache или Nginx с возможностью запуска php-скриптов.

## Редактирование Config.php для вашего сайта

Задача данного скрипта (config.php) состоит в корректной настройке соединения с вашей базой данных, в котором содержатся необходимые таблицы пользователей и ваш SMTP. Кроме этого, скрипт создает SQL-запрос, который должен возвращать email адрес из user_uid (описано в Шаге 1).

Откройте файл и измените следующие параметры:


