---
layout: doc
title:  "Precheckout"
section: integration
---

## Необходимые требования для начала интеграции
Для корректной работы модуля Pre-checkout на сайте должна присутствовать общая интеграция и модуль Post-checkout. 


## Ход интеграции 

## 1. Код интеграции Pre-checkout

Данный шаг абсолютно идентичен общей интеграции Flocktory. Если она уже проведена, то выполнять это пункт не нужно. Иначе следует произвести следующие действия:

1.1. Поместить в тег <head> Вашего сайта следующий код:
```html
<script type="text/javascript" src="https://api.flocktory.com/v2/loader.js?site_id=YOUR_SITE_ID" async="async"></script>
```
Он является общим для всех продуктов Flocktory и достаточно разместить его один раз, даже если на странице установлено несколько модулей (например Exchange и Post-checkout)
1.2. Замените YOUR_SITE_ID на присвоенный Вашему сайту ID. Узнать его Вы можете в [личном кабинете.](https://cabinet.flocktory.com/)

![LC](https://github.com/flocktory/flocktory.github.io/blob/7e32b4431960d0833b0a6950a4ef16177f9e014c/_docs_ru/integration/LC.png?raw=true)


## 2. Код авторизации

Данный модуль позволяет Flocktory увидеть факт авторизации пользователя на сайте и запустить соответсвующие кампании и ограничить показ кампаний, не предназначенных для показа неавторизованным пользователям.
Для интеграции данного модуля поместите на каждой странице следующий код:

```html
<div class="i-flocktory" data-fl-user-name="Ivan Petrov" data-fl-user-email="ivan@petrov.ru"></div>
```
До авторизации код передавать не нужно. После неё в параметры data-fl-user-name и  data-fl-user-email нужно передать вместо Ivan Petrov имя пользователя и вместо  ivan@petrov.ru   -  e-mail пользователя соответственно.
Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|data-fl-user-name | Имя пользователя     | Имя пользователя в формате «Имя Фамилия». Если имя неизвестно, то параметр передавать не нужно. |Нет|
|Data-fl-user-email |  E-mail пользователя      | E-mail пользователя в формате «email@domain.ru». Если адрес электронной почты неизвестен, то вместо него можно использовать номер телефона, передавая его в формате «79999999999@unknown.email». Если ни почта, ни номер телефона неизвестны, то используется ID клиента в вашей системе в формате «id@unknown.email»   |Да|


## 3. ID категорий

Данный модуль используется для определения того, какую категорию в данный момент просматривает клиент.
Для интеграции данного модуля на всех страницах товарного каталога, не являющихся карточками товара, вставьте следующий код:

```html
<div class="i-flocktory" data-fl-action="track-category-view" data-fl-category-id="123"></div>
```

Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|data-fl-category-id  |ID категории	| ID просматриваемой в данный момент категории, согласно используемому вами фиду. Если вы не используете фид, то данный параметр должен соответствовать ID данной категории в вашей БД      | Да |


## 4. ID товаров

Данный модуль используется для определения того, какой товар в данный момент просматривает клиент.
Для интеграции данного модуля на всех страницах товарного каталога, не являющихся карточками товара, вставьте следующий код:

```html
<div class="i-flocktory" data-fl-action="track-item-view" data-fl-item-id="123" data-fl-item-category-id="1" data-fl-item-vendor="Nike" data-fl-item-available="true"></div>
```
Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|data-fl-item-id  |ID товара	| ID просматриваемого в данный момент товара, согласно используемому вами фиду. Если вы не используете фид, то данный параметр должен соответствовать ID товара в вашей БД     | Да |
|data-fl-item-category-id |ID категории	| ID категории просматриваемого товара согласно фиду или БД   | Нет |
|data-fl-item-vendor |Производитель товара	| Производитель просматриваемого товара.    |Да (только для SPN)|
|data-fl-item-available |Наличие товара	| Для товара в наличии равен true иначе – false   |Нет|


## 5. Код состояния корзины

Данный модуль используется для передачи Flocktory информации о товарах, в данный момент находящихся в корзине клиента на сайте. Благодаря этой информации возможен запуск кампаний, ориентированных на действия с корзиной, например, по рекомендации похожих или сопутствующих товаров.
Для интеграции данного модуля выполните следующие действия:

5.1. При добавлении товара в корзину необходимо вызывать следующий JavaScript-код:

```html
window.flocktory = window.flocktory || [];
window.flocktory.push(['addToCart', {
	item: {
		"id": "123", // product id
		"price": 1200, // product price
		"count": 1, // quantity of this product added
		"brand": "smth inc", // product brand name
		"categoryId": "123123" // product category id
	}
}]);
```
5.2. При удалении товара из корзины необходимо вызывать следующий JavaScript-код:

```html
window.flocktory = window.flocktory || [];
window.flocktory.push(['removeFromCart', {
	item: {
		id: '124', // product id
		count: 2 // quantity of this product removed
	}
}]);
```
5.3. Кроме того, существует механика обновления корзины, подразумевающая передача Floctory текущего состояния корзины и последующего вычисления изменений на нашей стороне:

```html
window.flocktory = window.flocktory || [];
window.flocktory.push(['updateCart', {
  cart: {
    items:[
      {id:'1001', price: 100, count: 1},
      {id:'1011', price: 200, count: 1}
    ]
  }
}]);
```
Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|id |ID товара	| ID просматриваемого в данный момент товара, согласно используемому вами фиду. Если вы не используете фид, то данный параметр должен соответствовать ID товара в вашей БД     | Да |
|categoryId|ID категории	| ID категории просматриваемого товара согласно фиду или БД   | Нет |
|brand |Производитель товара	| Производитель просматриваемого товара.    |Да (только для SPN)|
|price |Цена товара	| Цена добавленного/удалённого товара с учётом скидок, если таковые имеются.   |Да|
|count |Количество	| Количество добавленного/удалённого товара  |Да|


## На что стоит обратить внимание

### 1. Код интеграции

	
* Site_id должен быть корректным, иначе будут запускать кампании, предназначенные для других сайтов;
	
* Часто встречается ошибка, когда при вставке id ставят пробел после знака равенства. Это неправильно и код работать не будет;
	
* Код обязательно должен находиться в header сайта.

	
### 2. Код авторизации

	
* Для неавторизованных код срабатывать не должен;
	
* Код должен передаваться не единожды после авторизации, а на всех страницах, где есть интеграция;
	
* В код должны передаваться данные сессии текущего пользователя. Не должно быть передачи чужих авторизационных данных;
	
* Должны передаваться и имя пользователя, и e-mail, если они известны;
	
* Значения по умолчанию могут быть только пусты, т.е. равняться “”.
	
* Если вы не знаете имя или почту пользователя, не передавайте нам их.


#### 3. ID категорий

	
•	3.1. Просмотр категории передается на всех страницах категорий;
	
•	3.2. Передаваемый id соответствует записи в фиде;
	
•	3.3. Должен передаваться один тег категории на странице;
	
•	3.4. Код нужно передавать только на страницах категорий, не на карточках товаров или других страницах.

	
*	4. ID товаров

	
•	4.1. Информация передается только на соответствующих страницах - карточках товара;
	
•	4.2. data-fl-item-id товара должен соответствовать ID товара в фиде;
	
•	4.3. id должен соответствовать данным, передаваемым при добавлении товара в корзину;
	
•	4.4. Если вы решили не поддерживать описанные опциональные параметры, то соответствующие атрибуты нужно пропустить;
	
•	4.5. Если опциональный параметр отсутствует для части продуктов, в этом случае нужно передавать пустую строку как значение соответствующего атрибута.


	
*	5. Код состояния корзины

	
•	5.1. Цена в коде должна соответствовать цене на карточке товара;

	
•	5.2. ID, передаваемый Flocktory, должен соответствовать id, передаваемому в теге просмотра карточки товара;
	
•	5.3. ID товара должен обязательно соответствовать id в вашем фиде, чтобы система смогла его определить;
	
•	5.4. Коды должны передаваться при следующих действиях на сайте:
	
•	5.4.1. Изменение количества товара кнопками +/- на странице товара и в корзине;
	
•	5.4.2.Изменение количества товаров вручную (ввод числа в поле на странице корзины);
	
•	5.4.3.Удаление из корзины одного/нескольких наименований;
	
•	5.4.4.Добавление товара из всех дополнительных блоков (похожие товары и т.п.);
	
•	5.4.5.При наличии скидки (например, с определенной суммы), она также должна учитываться при передаче цены;
	
•	5.4.6.Если у товара имеются вариации (цвет, размер) с различными ценами, необходимо передавать вариации товаров c различающимися id в соответствии с фидом. Если его нет, то нужно дописывать к id параметры, отвечающие за выбранные опции товаров;
	
•	5.4.7. При авторизации пользователя должно передаваться добавление товаров, которые уже имеются у него в Корзине (остались там с прошлого посещения сайта.
	
•	5.4.7.1. Обязательное ли это требование? Да
	
•	5.4.7.2. Для чего это нужно? Если информация о товарах в корзине не будет синхронизирована, наши кампании, работа которых завязана на состоянии корзины (кол-во товаров в корзине, общая стоимость товаров, бренд товаров и т.д.), будут работать некорректно.
	
•	5.4.7.3. Как это сделать? После авторизации пользователя после того, как корзина на сайте будет обновлена, необходимо передать ее состояние, вызвав updateCart (см пункт 5.3 данной инструкции)
	
•	5.5. В параметр count должно передаваться именно количество добавленного/удалённого товара, а не конечное его количество.

## Как проверить, что коды работают

*	1. Код интеграции	

•	1.1. Откройте любую страницу Вашего сайта, нажмите F12 или Shift + Ctrl + I чтобы открыть панель инструментов разработчика;

•	1.2. Выберите вкладку network и обновите страницу;

![int1](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen1.png?raw=true)

	
•	1.3. В поле «Фильтр» введите слово Flocktory;

![int2](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen2.png?raw=true)

	
•	1.4. Среди появившихся  запросов найдите запрос с названием  ultimate, нажмите на него и выберите вкладку «Headers»	
![int3](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen3.png?raw=true)

![int4](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen4.png?raw=true)

•	1.5. Прокрутите содержимое вкладки до конца, и найдите site_id. Он должен совпадать с вашим.	

![int5](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen5.png?raw=true)

![int6](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen6.png?raw=true)


•	1.6. Найдите запись с заголовком «ultimate.js» и проверьте, что его параметр «site» равен вашему site_id
![int7](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen7.png?raw=true)

*	2. Код авторизации

	
• 	2.1. Выполните действия из пунктов 1.1 – 1.3. После этого авторизуйтесь на сайте и найдите запись с заголовком «setup-api» по аналогии с пунктом 1.4. Если записей две, то выбирайте ту, что находится ниже в списке. Проверьте, что параметры name и email соответствуют введённым вами данным

![auth_code](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/auth_code.png?raw=true)


	
*	3. ID категорий и товаров

	
•	3.1. Для проверки корректности передачи ID категорий выполните действия из пунктов 1.1 – 1.3. После этого зайдите на страницу категории и найдите запись с заголовком «ultimate.js» по аналогии с пунктом 1.4. Записей должно быть две, выбирайте ту, у которой есть параметр action":"customer.category_visit". 

![id_cath1](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath1.png?raw=true)


	
•	3.2. Проверьте, что параметр yandex_category соответствует ID данной категории в вашей БД

![id_cath2](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath2.png?raw=true)

	
•	 3.3. Для проверки корректности передачи ID категорий выполните действия из пунктов 1.1 – 1.3. После этого зайдите на страницу товара и найдите запись с заголовком «ultimate.js» по аналогии с пунктом 1.4. Записей должно быть две, выбирайте ту, у которой есть параметр action":"customer.item_visit".

![id_cath3](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath3.png?raw=true)

	
•	3.4. Проверьте, что параметр yandex_offer соответствует ID данного товара в вашей БД

![id_cath4](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath4.png?raw=true)

* 4. Код состояния корзины

	
•	4.1. Для проверки корректности передачи данных о добавленных в корзину товарах выполните действия из пунктов 1.1 – 1.3. После этого добавьте товар в корзину и найдите запись с заголовком «ultimate.js» по аналогии с пунктом 1.4. Записей может быть несколько, выбирайте ту, у которой есть параметр action":"customer.add_to_cart".

![id_cath5](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath5.png?raw=true)

	
•	4.2. Проверьте, что параметры в payload соответствует данным добавленного товара

![id_cath6](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath6.png?raw=true)


•   4.3. Для проверки корректности передачи данных об удалённых из корзины товарах выполните действия из пунктов 1.1 – 1.3. После этого добавьте товар в корзину и найдите запись с заголовком «ultimate.js» по аналогии с пунктом 1.4. Записей может быть несколько, выбирайте ту, у которой есть параметр action":"customer.remove_from_cart".

![id_cath7](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath7.png?raw=true)
	
•4.4. Проверьте, что параметры в payload соответствует данным удалённого товара

![id_cath8](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath8.png?raw=true)



• 4.5. Для проверки корректности обновления корзины механикой updateCart откройте вкладку «Consloe» инструментов разработчика. После этого произведите любое действие с корзиной и введите в консоль flocktory.getData().cart.items. Сравните содержимое появившегося массива с корзиной 

 ![id_cath9](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath9.png?raw=true)



