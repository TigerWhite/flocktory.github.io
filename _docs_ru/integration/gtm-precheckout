---
layout: doc
title:  " GTM Precheckout"
section: integration
---
## Интеграция Precheckout через [Google Tag Manager](https://www.google.com/intl/ru/tagmanager/)

## Необходимые требования для начала интеграции
Для корректной работы модуля Precheckout на сайте должна присутствовать [Общая интеграция](https://flocktory.github.io/ru/integration/general/). 


## 1. Код интеграции Prechekout

Данный шаг абсолютно идентичен Общей интеграции Flocktory. Если она уже проведена, то выполнять этот пункт не нужно. Иначе следует произвести следующие действия:


* Откройте [Google Tag Manager](https://tagmanager.google.com/#/home) и перейдите в раздел «Теги»:

![screen1](https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/1.png?raw=true)

	
* Откройте окно создания тегов при помощи кнопки «Создать»:

![screen2](https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/2.png?raw=true)

* Введите название нового тега:

![screen3](h*ttps://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/3.png?raw=true)

* Нажмите на поле «Конфигурация тега» и выберите тип тега «Пользовательский HTML»:

![screen4](https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/4.png?raw=true)

* Вставьте следующий код в поле HTML и включите поддержку функции «document.write»:

```html
<script type="text/javascript"src="//api.flocktory.com/v2/loader.js?site_id=YOUR_SITE_ID" async="async"></script>
```

![screen5]  (https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/5.png?raw=true)

* Замените YOUR_SITE_ID на присвоенный вашему сайту ID. Узнать его Вы можете в Личном кабинете:

![screen6](https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/6.png?raw=true)

* Нажмите на поле «Триггеры» и выбрать из списка триггер «All pages»:

![screen7](https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/7.png?raw=true)

* Сохраните внесенные изменения при помощи кнопки «Сохранить»:

![screen8](https://github.com/flocktory/flocktory.github.io/blob/9f4c3c2b74dc098a5a3899f2ae17b0f102f2fafe/_docs_ru/integration/8.png?raw=true)


## 2. Код авторизации

Данный модуль позволяет Flocktory увидеть факт авторизации пользователя на сайте и запустить соответствующие кампании и ограничить показ кампаний, не предназначенных для показа неавторизованным пользователям.
Для интеграции данного модуля выполните следующие действия:

* Откройте вкладку «Теги» и нажмите кнопку «Создать»:

![screen21](https://github.com/flocktory/flocktory.github.io/blob/b0382a2c558a0f8dec997c38cdb62cd5ed7b7173/21.png?raw=true)

* Введите название тега и выберите тип «Пользовательский HTML»:

![screen22](https://github.com/flocktory/flocktory.github.io/blob/b0382a2c558a0f8dec997c38cdb62cd5ed7b7173/22.png?raw=true)

* Поместите в поле HTML следующий код:

```html
<div class="i-flocktory" data-fl-action="track-category-view" data-fl-category-id="123"></div>
```
Где {{VisitorName}} и {{VisitorEmail}} – заранее созданные Вами переменные, содержащие данные об имени и e-mail клиента соответственно:

![screen23](https://github.com/flocktory/flocktory.github.io/blob/b0382a2c558a0f8dec997c38cdb62cd5ed7b7173/23.png?raw=true)

* Привяжите тег к триггеру, срабатывающему, если пользователь авторизован, и сохраните изменения. О том как привязывать тег к триггеру Вы можете прочитать в первой части инструкции.


Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|data-fl-user-name |Имя пользователя| Имя пользователя в формате «Имя Фамилия». Если имя неизвестно, то параметр передавать не нужно.     | Нет |
|Data-fl-user-email |E-mail пользователя	| E-mail пользователя в формате «email@domain.ru». Если адрес электронной почты неизвестен, то вместо него можно использовать номер телефона, передавая его в формате «79999999999@unknown.email». Если ни почта, ни номер телефона неизвестны, то используется ID клиента в вашей системе в формате «id@unknown.email»   | Да |



## 3. ID категорий

Данный модуль используется для определения того, какую категорию в данный момент просматривает клиент.
Для интеграции данного модуля выполните следующие действия:


* Откройте вкладку «Теги» и нажмите кнопку «Создать»:

![screen31](https://github.com/flocktory/flocktory.github.io/blob/89bc3b320b905663e0bfed29fc9192c42cb430ff/31.png?raw=true)

* Введите название тега и выберите тип «Пользовательский HTML»:

![screen32](https://github.com/flocktory/flocktory.github.io/blob/89bc3b320b905663e0bfed29fc9192c42cb430ff/32.png?raw=true)

* Поместите в поле HTML следующий код:

```html
<div class="i-flocktory" data-fl-action="track-category-view" data-fl-category-id={{CatID}}></div>
```
Где {{CatID}} – заранее созданная Вами переменная, хранящая ID просматриваемой в данный момент категории.

![screen33](https://github.com/flocktory/flocktory.github.io/blob/89bc3b320b905663e0bfed29fc9192c42cb430ff/33.png?raw=true)


* Привяжите тег к триггеру, срабатывающему при просмотре страницы категории, и сохраните изменения. О том как привязывать тег к триггеру Вы можете прочитать в первой части инструкции.


Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|data-fl-category-id  |ID категории	| ID просматриваемой в данный момент категории, согласно используемому вами фиду. Если вы не используете фид, то данный параметр должен соответствовать ID данной категории в вашей БД      | Да |


## 4. ID товаров

Данный модуль используется для определения того, какой товар в данный момент просматривает клиент.
Для интеграции данного модуля выполните следующие действия:

* Откройте вкладку «Теги» и нажмите кнопку «Создать»:

![screen41](https://github.com/flocktory/flocktory.github.io/blob/89bc3b320b905663e0bfed29fc9192c42cb430ff/41.png?raw=true)

* Введите название тега и выберите тип «Пользовательский HTML»:

![screen42](https://github.com/flocktory/flocktory.github.io/blob/89bc3b320b905663e0bfed29fc9192c42cb430ff/42.png?raw=true)

* Поместите в поле HTML следующий код:


```html
<div class="i-flocktory" data-fl-action="track-item-view" data-fl-item-id= {{zItemID}} data-fl-item-category-id="1" data-fl-item-vendor="Nike" data-fl-item-available="true"></div>
```

Где {{zItemID}} – заранее созданная Вами переменная, хранящая ID просматриваемого в данный момент товара. 

![screen43](https://github.com/flocktory/flocktory.github.io/blob/89bc3b320b905663e0bfed29fc9192c42cb430ff/43.png?raw=true)

* Привяжите тег к триггеру, срабатывающему при просмотре товара и сохраните изменения. О том как привязывать тег к триггеру Вы можете прочитать в первой части инструкции.


Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|data-fl-item-id  |ID товара	| ID просматриваемого в данный момент товара, согласно используемому вами фиду. Если вы не используете фид, то данный параметр должен соответствовать ID товара в вашей БД     | Да |
|data-fl-item-category-id |ID категории	| ID категории просматриваемого товара согласно фиду или БД   | Нет |
|data-fl-item-vendor |Производитель товара	| Производитель просматриваемого товара.    |Да (только для SPN)|
|data-fl-item-available |Наличие товара	| Для товара в наличии равен true иначе – false   |Нет|


## 5. Код состояния корзины

Данный модуль используется для передачи Flocktory информации о товарах, в данный момент находящихся в корзине клиента на сайте. Благодаря этой информации возможен запуск кампаний, ориентированных на действия с корзиной, например, по рекомендации похожих или сопутствующих товаров.
Для интеграции данного модуля выполните следующие действия:

* Откройте вкладку «Теги» и нажмите кнопку «Создать»:

![screen51](https://github.com/flocktory/flocktory.github.io/blob/6ea75796cdc4043f8404b8f05995be2636f52d39/51.png?raw=true)

* Введите название тега и выберите тип «Пользовательский HTML»:

![screen52](https://github.com/flocktory/flocktory.github.io/blob/6ea75796cdc4043f8404b8f05995be2636f52d39/52.png?raw=true)


* Поместите в поле HTML следующий код. Он отвечает за добавление товара в корзину Flocktory:

```html
window.flocktory = window.flocktory || [];
window.flocktory.push(['addToCart', {
	item: {
		"id": {{Ecommerce}}.add.products[0].id, // product id
		"price": {{Ecommerce}}.add.products[0].price, // product price
		"count": {{Ecommerce}}.add.products[0].quantity, // quantity of this product added
		"brand": {{Ecommerce}}.add.products[0].brand, // product brand name
		"categoryId": {{Ecommerce}}.add.products[0].category // product category id
	}
}])
```

 Где {{Ecommerce}} – заранее созданная Вами переменная, хранящая данные о добавленном в корзину товаре. Вы можете использовать массив, как в примере, либо создать отдельную переменную для каждого параметра.

![screen53](https://github.com/flocktory/flocktory.github.io/blob/6ea75796cdc4043f8404b8f05995be2636f52d39/53.png?raw=true)

* Привяжите тег к триггеру, срабатывающему при добавлении товара в корзину, и сохраните изменения. О том как привязывать тег к триггеру Вы можете прочитать в первой части инструкции.

*  Создайте тег для кода удаления товара, согласно пунктам 5.1 – 5.2 и впишите в поле HTML следующий код:

```html
window.flocktory = window.flocktory || [];
window.flocktory.push(['removeFromCart', {
	item: {
		id: {{Ecommerce}}.remove.products[0].id, // product id
		count: {{Ecommerce}}.remove.products[0].quantity // quantity of this product removed
	}
}]);
```

Где {{Ecommerce}} – заранее созданная Вами переменная, хранящая данные об удалённом из корзины товаре. Вы можете использовать массив, как в примере, либо создать отдельную переменную для каждого параметра.

![screen55](https://github.com/flocktory/flocktory.github.io/blob/6ea75796cdc4043f8404b8f05995be2636f52d39/54.png?raw=true)

* Привяжите тег к триггеру, срабатывающему при удалении товара из корзины, и сохраните изменения. О том как привязывать тег к триггеру Вы можете прочитать в первой части инструкции.

* Если Вам необходимо использовать механику updateCart, позволяющую обновить состояние корзины Flocktory, то создайте тег для кода удаления товара, согласно пунктам 5.1 – 5.2 и впишите в поле HTML следующий код:

```html
window.flocktory = window.flocktory || [];
window.flocktory.push(['updateCart', {
  cart: {
    items:{{Cart}}
  }
}]);
```
Где {{Cart}} – заранее созданная Вами переменная, хранящая в себе актуальное состояние корзины. 

![screen55](https://github.com/flocktory/flocktory.github.io/blob/6ea75796cdc4043f8404b8f05995be2636f52d39/55.png?raw=true)

* Привяжите тег к триггеру, срабатывающему при при подразумевающем обновление корзины действии, и сохраните изменения. О том как привязывать тег к триггеру Вы можете прочитать в первой части инструкции.


Параметры кода:

| Название параметра     | Параметр               | Описание  |         Обязательный                    |
|:------------:|:------------------:|:---------------:|:----------------------------------------------:|
|id |ID товара	| ID просматриваемого в данный момент товара, согласно используемому вами фиду. Если вы не используете фид, то данный параметр должен соответствовать ID товара в вашей БД     | Да |
|categoryId|ID категории	| ID категории просматриваемого товара согласно фиду или БД   | Нет |
|brand |Производитель товара	| Производитель просматриваемого товара.    |Да (только для SPN)|
|price |Цена товара	| Цена добавленного/удалённого товара с учётом скидок, если таковые имеются.   |Да|
|count |Количество	| Количество добавленного/удалённого товара  |Да|



## На что стоит обратить внимание

### 1. Код интеграции

	
* Site_id должен быть корректным, иначе будут запускать кампании, предназначенные для других сайтов;
	
* Часто встречается ошибка, когда при вставке id ставят пробел после знака равенства. Это неправильно и код работать не будет;
	
* Код обязательно должен находиться в header сайта.

	
### 2. Код авторизации

	
* Для неавторизованных код срабатывать не должен;
	
* Код должен передаваться не единожды после авторизации, а на всех страницах, где есть интеграция;
	
* В код должны передаваться данные сессии текущего пользователя. Не должно быть передачи чужих авторизационных данных;
	
* Должны передаваться и имя пользователя, и e-mail, если они известны;
	
* Значения по умолчанию могут быть только пусты, т.е. равняться “”;
	
* Если вы не знаете имя или почту пользователя, не передавайте нам их.


### 3. ID категорий

	
* Просмотр категории передается на всех страницах категорий;
	
* Передаваемый id соответствует записи в фиде;
	
* Должен передаваться один тег категории на странице;
	
* Код нужно передавать только на страницах категорий, не на карточках товаров или других страницах.

	
### 4. ID товаров

	
* Информация передается только на соответствующих страницах - карточках товара;
	
* data-fl-item-id товара должен соответствовать ID товара в фиде;
	
* id должен соответствовать данным, передаваемым при добавлении товара в корзину;
	
* Если вы решили не поддерживать описанные опциональные параметры, то соответствующие атрибуты нужно пропустить;
	
* Если опциональный параметр отсутствует для части продуктов, в этом случае нужно передавать пустую строку как значение соответствующего атрибута.


	
### 5. Код состояния корзины

	
* Цена в коде должна соответствовать цене на карточке товара;

* ID, передаваемый Flocktory, должен соответствовать id, передаваемому в теге просмотра карточки товара;
	
* ID товара должен обязательно соответствовать id в вашем фиде, чтобы система смогла его определить;
	
* Коды должны передаваться при следующих действиях на сайте:
	
    * Изменение количества товара кнопками +/- на странице товара и в корзине;
    * Изменение количества товаров вручную (ввод числа в поле на странице корзины);
    * Удаление из корзины одного/нескольких наименований;
    * Добавление товара из всех дополнительных блоков (похожие товары и т.п.);
* При наличии скидки (например, с определенной суммы), она также должна учитываться при передаче цены;
* Если у товара имеются вариации (цвет, размер) с различными ценами, необходимо передавать вариации товаров c различающимися id в соответствии с фидом. Если его нет, то нужно дописывать к id параметры, отвечающие за выбранные опции товаров;
* При авторизации пользователя должно передаваться добавление товаров, которые уже имеются у него в Корзине (остались там с прошлого посещения сайта):

    * Обязательное ли это требование? Да.
    * Для чего это нужно? Если информация о товарах в корзине не будет синхронизирована, наши кампании, работа которых завязана на состоянии корзины (количество товаров в корзине, общая стоимость товаров, бренд товаров и т.д.), будут работать некорректно.
    * Как это сделать? После авторизации пользователя после того, как корзина на сайте будет обновлена, необходимо передать ее состояние, вызвав updateCart.
* В параметр count должно передаваться именно количество добавленного/удалённого товара, а не конечное его количество.



## Как проверить, что коды работают

### 1. Код интеграции	

* Откройте любую страницу вашего сайта, нажмите F12 или Shift + Ctrl + I, чтобы открыть панель инструментов разработчика;

* Выберите вкладку network и обновите страницу;

![int1](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen1.png?raw=true)

	
* В поле «Фильтр» введите слово Flocktory;

![int2](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen2.png?raw=true)

	
* Среди появившихся  запросов найдите запрос с названием  ultimate, нажмите на него и выберите вкладку «Headers»;

![int3](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen3.png?raw=true)


![int4](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen4.png?raw=true)

* Прокрутите содержимое вкладки до конца, и найдите site_id. Он должен совпадать с вашим;	

![int5](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen5.png?raw=true)


![int6](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen6.png?raw=true)


* Найдите запись с заголовком «ultimate.js» и проверьте, что его параметр «site» равен вашему site_id;

![int7](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/screen7.png?raw=true)

### 2. Код авторизации 
	
* Выполните действия из первых трех пунктов раздела [Код интеграции](#1-код-интеграции-1). После этого авторизуйтесь на сайте и найдите запись с заголовком «setup-api» по аналогии с четвертым пунктом. Если записей две, то выбирайте ту, что находится ниже в списке. Проверьте, что параметры name и email соответствуют введённым вами данным;

![auth_code](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/auth_code.png?raw=true)


### 3. ID категорий и товаров 


* Для проверки корректности передачи ID категорий выполните действия из первых трех пунктов раздела [Код интеграции](#1-код-интеграции-1). После этого зайдите на страницу категории и найдите запись с заголовком «ultimate.js» по аналогии с четвертым пунктом. Записей должно быть две, выбирайте ту, у которой есть параметр action":"customer.category_visit"; 

![id_cath1](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath1.png?raw=true)


* Проверьте, что параметр yandex_category соответствует ID данной категории в вашей БД;

![id_cath2](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath2.png?raw=true)

	
* Для проверки корректности передачи ID товара выполните действия из первых трех пунктов раздела [Код интеграции](#1-код-интеграции-1). После этого зайдите на страницу товара и найдите запись с заголовком «ultimate.js» по аналогии с четвертым пунктом. Записей должно быть две, выбирайте ту, у которой есть параметр "action":"customer.item_visit";

![id_cath3](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath3.png?raw=true)

	
* Проверьте, что параметр yandex_offer соответствует ID данного товара в вашей БД;

![id_cath4](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath4.png?raw=true)

### 4. Код состояния корзины

	
* Для проверки корректности передачи данных о добавленных в корзину товарах выполните действия из первых трех пунктов раздела [Код интеграции](#1-код-интеграции-1). После этого добавьте товар в корзину и найдите запись с заголовком «ultimate.js» по аналогии с четвертым пунктом. Записей может быть несколько, выбирайте ту, у которой есть параметр action":"customer.add_to_cart";

![id_cath5](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath5.png?raw=true)

	
* Проверьте, что параметры в payload соответствует данным добавленного товара;

![id_cath6](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath6.png?raw=true)


* Для проверки корректности передачи данных об удалённых из корзины товарах выполните действия из первых трех пунктов раздела [Код интеграции](#1-код-интеграции-1). После этого добавьте товар в корзину и найдите запись с заголовком «ultimate.js» по аналогии с четвертым пунктом. Записей может быть несколько, выбирайте ту, у которой есть параметр action":"customer.remove_from_cart";

![id_cath7](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath7.png?raw=true)


* Проверьте, что параметры в payload соответствует данным удалённого товара;

![id_cath8](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath8.png?raw=true)


* Для проверки корректности обновления корзины механикой updateCart откройте вкладку «Console» инструментов разработчика. После этого произведите любое действие с корзиной и введите в консоль flocktory.getData().cart.items. Сравните содержимое появившегося массива с корзиной. 

 ![id_cath9](https://github.com/flocktory/flocktory.github.io/blob/860040d8c399792c6678cc80eeaf447249049ef5/_docs_ru/integration/id_cath9.png?raw=true)



